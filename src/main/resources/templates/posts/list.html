<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Posts - Community</title>
</head>
<body>
<section>
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2">
                <i class="fas fa-list me-2"></i>All Posts
            </h1>
            <p class="text-muted">Discover and engage with community posts</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a th:href="@{/posts/new}" class="btn btn-primary" sec:authorize="isAuthenticated()">
                <i class="fas fa-plus me-2"></i>Create Post
            </a>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search posts..." id="searchInput">
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="general">General</option>
                <option value="technology">Technology</option>
                <option value="lifestyle">Lifestyle</option>
                <option value="entertainment">Entertainment</option>
            </select>
        </div>
    </div>

    <!-- Posts Grid -->
    <div class="row" id="postsContainer">
        <div class="col-md-6 col-lg-4 mb-4" th:each="post : ${posts}">
            <div class="card h-100 post-card">
                <!-- Post Images -->
                <div class="post-images" th:if="${post.postImages != null and !post.postImages.empty}">
                    <div id="carousel-${post.postId}" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active" th:each="image, iterStat : ${post.postImages}">
                                <img th:src="${image.imageUrl}" class="d-block w-100" 
                                     style="height: 200px; object-fit: cover;" alt="Post image">
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" 
                                th:data-bs-target="'#carousel-' + ${post.postId}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" 
                                th:data-bs-target="'#carousel-' + ${post.postId}" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                </div>
                
                <!-- Post Content -->
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0" th:text="${post.title}">Post Title</h5>
                        <span class="badge bg-primary" th:text="${post.category?.categoryStatus?.description}">Category</span>
                    </div>
                    
                    <p class="card-text text-muted" th:text="${#strings.abbreviate(post.content, 100)}">
                        Post content preview...
                    </p>
                    
                    <div class="mt-auto">
                        <!-- Post Stats -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <i class="fas fa-heart me-1"></i>
                                <span th:text="${post.likeCount != null ? post.likeCount : 0}">0</span> likes
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-comment me-1"></i>
                                <span th:text="${post.comments != null ? post.comments.size() : 0}">0</span> comments
                            </small>
                        </div>
                        
                        <!-- Author Info -->
                        <div class="d-flex align-items-center mb-3">
                            <img th:src="${post.user.profileImage}" alt="Author" 
                                 class="rounded-circle me-2" width="32" height="32"
                                 th:if="${post.user.profileImage != null}">
                            <i class="fas fa-user-circle me-2" th:unless="${post.user.profileImage != null}"></i>
                            <div>
                                <small class="fw-bold" th:text="${post.user.nickname}">Author</small>
                                <br>
                                <small class="text-muted" th:text="${#temporals.format(post.createdAt, 'MMM dd, yyyy')}">
                                    Date
                                </small>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <a th:href="@{/posts/{id}(id=${post.postId})}" class="btn btn-outline-primary btn-sm flex-fill">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            <button class="btn btn-outline-danger btn-sm" 
                                    th:if="${post.isLikedByCurrentUser != null and post.isLikedByCurrentUser}" 
                                    th:onclick="'unlikePost(' + ${post.postId} + ')'">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    th:unless="${post.isLikedByCurrentUser != null and post.isLikedByCurrentUser}" 
                                    th:onclick="'likePost(' + ${post.postId} + ')'">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Posts Message -->
    <div class="text-center py-5" th:if="${#lists.isEmpty(posts)}">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No posts yet</h4>
        <p class="text-muted">Be the first to create a post!</p>
        <a th:href="@{/posts/new}" class="btn btn-primary" sec:authorize="isAuthenticated()">
            <i class="fas fa-plus me-2"></i>Create First Post
        </a>
    </div>

    <!-- Pagination -->
    <nav th:if="${#lists.size(posts) > 0}" aria-label="Posts pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Previous</a>
            </li>
            <li class="page-item active">
                <a class="page-link" href="#">1</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">2</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">3</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
</section>

<!-- JavaScript for search and filtering -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const postsContainer = document.getElementById('postsContainer');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        filterPosts();
    });
    
    // Category filter
    categoryFilter.addEventListener('change', function() {
        filterPosts();
    });
    
    function filterPosts() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const postCards = postsContainer.querySelectorAll('.post-card');
        
        postCards.forEach(card => {
            const title = card.querySelector('.card-title').textContent.toLowerCase();
            const content = card.querySelector('.card-text').textContent.toLowerCase();
            const category = card.querySelector('.badge').textContent.toLowerCase();
            
            const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
});

// Like/Unlike functionality
function likePost(postId) {
    fetch(`/api/posts/${postId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

function unlikePost(postId) {
    fetch(`/api/posts/${postId}/unlike`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}
</script>
</body>
</html> 